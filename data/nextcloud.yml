version: "3.8"
name: data-nextcloud

services:
    nextclouddb:
        image: mariadb:10.5
        restart: always
        command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW
        volumes:
            - hl-v-nextcloud-db:/var/lib/mysql
        environment:
            MYSQL_ROOT_PASSWORD: ${ROOT_PASSWORD}
            MYSQL_PASSWORD: ${ROOT_PASSWORD}
            MYSQL_DATABASE: "nextcloud"
            MYSQL_USER: "nextcloud"
    nextcloud:
        container_name: hl-nextcloud
        build: ./Nextcloud.dockerfile
        restart: always
        depends_on:
            - nextclouddb
        ports:
            - 8080:80
        volumes:
            - hl-v-nextcloud-data:/var/www/html
            - ./nextcloud:/opt/nextcloud/data:rw
        environment:
            MYSQL_HOST: "nextclouddb"
            MYSQL_DATABASE: "nextcloud"
            MYSQL_USER: "nextcloud"
            MYSQL_PASSWORD: ${ROOT_PASSWORD}
            NEXTCLOUD_TRUSTED_DOMAINS: "cloud.alemax.site"
            TRUSTED_DOMAINS: "cloud.alemax.site"
            OVERWRITEHOST: "cloud.alemax.site"
            OVERWRITEPROTOCOL: "https"
            OVERWRITECONDADDR: "^192\\.168\\.0\\.21$"
            OVERWRITECLIURL: "https://cloud.alemax.site"
            NEXTCLOUD_DATA_DIR: "/opt/nextcloud/data"
            NEXTCLOUD_TRUSTED_PROXIES: "192.168.0.21"
volumes:
    hl-v-nextcloud-data:
    hl-v-nextcloud-db:
